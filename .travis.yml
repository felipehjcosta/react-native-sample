branches:
  only:
    - master
    
env:
  global:
    - NODE_VERSION=stable
  
matrix:
  include:
    - language: node_js
      node_js: 8
      cache:
        yarn: true
      before_install:
        - curl -o- -L https://yarnpkg.com/install.sh | bash
        - export PATH="$HOME/.yarn/bin:$PATH"
      install:
        - yarn install
        - yarn add codecov --dev
      script:
        - yarn install
        - yarn test && codecov
        
    - language: objective-c
      os: osx
      osx_image: xcode9.3
      cache:
        - yarn
      before_install:
        - export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        - nvm install $NODE_VERSION
        - nvm use $NODE_VERSION
        - brew update
        - brew install yarn || brew upgrade yarn
        - brew tap wix/brew
        - brew install --HEAD applesimutils || brew upgrade --HEAD applesimutils
      install:
        - npm install -g react-native-cli
        - npm install -g detox-cli
        
        - yarn install
      script:
        - detox build --configuration ios.sim.release
        - detox test --configuration ios.sim.release --cleanup
        
    - language: android
      sudo: required
      jdk: oraclejdk8
      android:
        components:
          # Uncomment the lines below if you want to
          # use the latest revision of Android SDK Tools
          - platform-tools
          - tools

          # The BuildTools version used by your project
          - build-tools-27.0.3

          # The SDK version used to compile your project
          - android-27
          - android-26
          - android-23
          - android-21

          # Additional components
          #- extra-google-google_play_services
          - extra-google-m2repository
          - extra-android-m2repository
          - sys-img-armeabi-v7a-android-21
      cache:
        directories:
          - $HOME/.yarn-cache
          - $HOME/.gradle/caches/
          - $HOME/.gradle/wrapper/
          - $HOME/.android/build-cache
      before_install:
        - yes | sdkmanager "platforms;android-27"
        - nvm install $NODE_VERSION
        - nvm use $NODE_VERSION
        - node --version
        - npm install -g yarn
      install:
        - npm install -g react-native-cli
        - npm install -g detox-cli

        - yarn install

      before_script:
        # Do not cache a few Gradle files/directories (see https://docs.travis-ci.com/user/languages/java/#Caching)
        - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
        - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

        # Create and start an emulator for instrumentation tests.
        - android-update-sdk --components=sys-img-$ABI-$API --accept-licenses='android-sdk-license-[0-9a-f]{8}'
        - echo no | android create avd --force -n test -t android-21 --abi armeabi-v7a
        - emulator -avd test -no-skin -no-audio -no-window -gpu off &
        - android-wait-for-emulator
        - adb devices
        - adb shell input keyevent 82 &

        - android-wait-for-emulator
      script: .travis/run-android-ci.sh